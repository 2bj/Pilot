/**!
 * Multifunction JavaScript router
 * @author	RubaXa	<trash@rubaxa.org>
 *
 * @example
 * 	var Moses = new Pilot;
 *
 * 	Moses.createGroup('/', { id: 'home' })
 * 		.route('*', app.LeftCol)
 * 		.route('.', app.Index)
 * 		.createGroup('blog/', { id: 'blog' } )
 * 			.route('.', app.BlogPosts)
 * 			.route('post/:id', app.BlogPost, { id: 'blog-post' })
 * 			.closeGroup()
 * 		.route('about', { id: 'about' })
 * 	;
 *
 * 	Moses.nav('/blog/');
 * 	// OR
 * 	Moses.go('blog-post', { id: 2 });
 */
(function(l,e){function n(a,b,d){if(a){var c=0,f=a.length;if(c in a&&f!==p)for(;c<f;c++)b.call(d,a[c],c,a);else for(c in a)a.hasOwnProperty(c)&&b.call(d,a[c],c,a)}}function h(a,b){var d=arguments,c=1,f=d.length,m;for(a=a||{};c<f;c++)if((b=d[c])&&"object"==typeof b)for(m in b)b.hasOwnProperty(m)&&(a[m]=b[m]);return a}function C(a,b,d,c){if(a instanceof RegExp)return a;e.isArray(a)&&(a="("+a.join("|")+")");a=a.concat(c?"":"/?").replace(/(\/\(|\(\/)/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\([^?].*?\)))?(\?)?(\*)?/g,
function(a,c,d,e,g,r,h){b.push({name:e,optional:!!r});c=c||"";return""+(r?"":c)+"(?:"+(r?c:"")+(d||"")+(g||d&&"([^/.]+?)"||"([^/]+?)")+")"+(r||"")+(h?"(/*)?":"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)");return RegExp("^"+a+"$",d?"":"i")}function w(a,b,d,c){if(d){var f=1,m,e=b.exec(a);if(!e)return!1;for(a=e.length;f<a;++f)b=d[f-1],m="string"==typeof e[f]?decodeURIComponent(e[f]):e[f],b?c[b.name]=m:c.push(m);return!0}return b.test(a)}var D=0,t=function(){},p=void 0,x=l.history,y=l.document,
k=l.location,z=/^https?/i,A=[].slice,E={}.toString,s=function(a,b){var d=A.call(arguments,2);return b.bind?b.bind.apply(b,[a].concat(d)):function(){return b.apply(a,d.concat(A(arguments)))}},B=function(a){var b=function(){if(b.fn.singleton){if(b.__inst__)return b.__inst__;b.__inst__=this}this.cid=this.uniqId=++D;this.__lego.apply(this,arguments)};b.fn=b.prototype=a||{};b.fn.__self=b.fn.constructor=b;b.extend=function(a){var c=B();t.prototype=this.fn;c.prototype=new t;h(c,this);h(c.fn=c.prototype,
a);return c.fn.__self=b.fn.constructor=c};return b},u=B({__lego:function(){var a=e(this);n({on:"bind",off:"unbind",fire:"triggerHandler"},function(b,d){this[d]=function(){a[b].apply(a,arguments);return this}},this)},emit:function(a,b){var d=("on-"+a).replace(/-(.)/g,function(a,b){return b.toUpperCase()}),c=e.Event(a.replace(/-/g,""));c.target=this;if((this[d]===p||!1!==this[d].apply(this,[c].concat(b)))&&!c.isImmediatePropagationStopped())return this.fire(c,b)}}),g=u.extend({__lego:function(a){u.fn.__lego.call(this);
h(this,{el:null,path:"/",production:!1,useHistory:!1},a);this.items=[];this.itemsIdx={};this.request=this.referrer=g.parseURL(g.getLocation());this.history=[];this.historyIdx=0;a&&(a.useHistory&&e(l).bind("popstate hashchange",s(this,function(){this.nav(g.getLocation())})),a.el&&e(a.el).delegate("a[href],[data-nav]","click",s(this,function(a){this.nav(a.currentTarget.href);a.preventDefault()})));this.on("error",s(this,function(a,d){this.error(d.message+" at "+d.line+"line in "+(d.file||""));this.log(d.stack)}));
this.init()},init:function(){},route:function(a,b,d,c,f){a=this.addRoute(a,b,d,c,f);return f?a:this},addRoute:function(a,b,d,c,f){/string|regexp/i.test(E.call(b))||(c=d,d=b,b=a,a=p);if(d&&!d.fn){var e=d;d=v.extend("function"!=typeof e?e:{init:function(){this.on("routestart routechange"+(!0===c?" routeend":""),e)}})}b=(this.path+("."==b?"":b)).replace(/\/\//,"/");var j=[],h=this,q;f&&(h=new g({path:b}),h.items=this.items,h.itemsIdx=this.itemsIdx,h.parentRouter=this);d&&(q=this.items.push({id:a,path:b,
keys:j,regexp:C(b+(f?"*":""),j),unit:d||g.View,options:c}),a&&(this.itemsIdx[a]=q-1));return f?h:q},removeRoute:function(a){a=this.itemsIdx[a]||a;this.items.splice(a,1)},createGroup:function(a,b,d,c){return this.route(a,b,d,c,!0)},closeGroup:function(){return this.parentRouter||this},_getUnits:function(a,b){var d=[];n(b,function(b){var f=b.unit,e=[];w(a.path,b.regexp,b.keys,e)&&(f.__self===p&&(b.unit=f=new f(h({id:b.id,router:this,inited:!1},b.options))),f.requestParams=e,d.push(f))},this);return d},
_loadUnits:function(a,b){var d=[],c;for(b=b.concat();c=b.shift();)if(c&&c.isActive()){n(c.units,function(a){b.push(a)});a.params=c.requestParams;if(c.loadData)try{c=c.loadData(a,this._navByHistory)}catch(f){return f.name="loadData",this.emit("error",f),e.Deferred().reject()}e.isArray(c)?b.push.apply(b,c):c&&d.push(c)}return e.when.apply(e,d)},_doRouteUnits:function(a,b){n(b,function(b){var c=b.unit,f=!0,g=[],j=h({},a);j.params=g;c.request=j;if(w(j.path,b.regexp,b.keys,g)){!0!==c.inited&&c.__init();
if(!0!==c.active){f=!1;c.active=!0;try{c.emit("route-start",j)}catch(k){k.name="routestart",this.emit("error",k,j)}}try{c.emit("route",j)}catch(q){q.name="route",this.emit("error",q,j),this.emit("routeerror",q,j)}if(f)try{c.emit("route-change",j)}catch(r){r.name="routechange",this.emit("error",r,j)}}else if(!0===c.active&&!~e.inArray(c,this.activeUnits)){c.active=!1;try{c.emit("route-end",j)}catch(l){l.name="routeend",this.emit("geterror",l,j)}}},this)},_doRouteDone:function(a){if(this.activeRequest===
a){this.request.url!=a.url&&(this.referrer=this.request,this.useHistory&&g.setLocation(a));this.request=a;this._navByHistory||(this.history=this.history.slice(0,this.historyIdx+1),this.historyIdx=this.history.push(a.url)-1);if(this.items.length)try{this._doRouteUnits(a,this.items)}catch(b){b.name="route",this.emit("error",b)}var d=new Date-this.__ts;this.emit("route",[a,d]);this.log("Pilot.nav: "+d+"ms ("+a.url+")")}},_doRouteFail:function(a){this.activeRequest===a&&(this.activeRequest=null,this.emit("route-fail",
a))},log:function(a){!this.production&&l.console&&console.log(a)},error:function(a){this.production||(l.console&&console.error?console.error(a):this.log(a))},get:function(a){return this.items[this.itemsIdx[a]]},getUrl:function(a,b,d){a=this.get(a);var c,e,g=0;a&&(b=h({},b,d),c=a.keys,e=a.path.replace(/:(\w+)\??(\/?)/g,function(a,d,e,f){return(f=(d=c[g++])&&b[d.name])?f+(e||""):"("+a+")"}).replace(/\(.*?:[^)]+\)+\??/g,"").replace(/\(|\)\??/g,"").replace(/\/+/g,"/"));return e},start:function(a){this.started||
this._nav(a||this.request,!1,!0)},_nav:function(a,b,d){var c=e.Deferred();a=g.parseURL(a.href||a.url||a);this.started=!0;this._navByHistory=!!b;d||!this.activeRequest||this.activeRequest.url!=a.url?(this.__ts=+new Date,this.emit("before-route",[a,this.__ts]),b=this._getUnits(a,this.items),a.referrer=this.request.url,this.activeUnits=b,this.activeRequest=a,b.length?this._loadUnits(a,b).done(s(this,this._doRouteDone,a)).fail(s(this,this._doRouteFail,a)).then(c.resolve,c.reject):(this._doRouteDone(a),
this.emit("404",a),c.reject())):c.resolve();return c.promise()},nav:function(a,b,d){e.isFunction(b)&&(d=b,b=!1);return this._nav(a,!1,b).then(d,d)},go:function(a,b){var d=this.getUrl(a,b);return d?this.nav(d):e.Deferred().reject().promise()},hasBack:function(){return 0<this.historyIdx},back:function(){return this.hasBack()?this._nav(this.history[--this.historyIdx],!0):e.Deferred().resolve()},hasForward:function(){return!!this.history[this.historyIdx+1]},forward:function(){return this.hasForward()?
this._nav(this.history[++this.historyIdx],!0):e.Deferred().resolve}});g.parseURL=function(a){z.test(a)||(a="/"==a.charAt(0)?"//"+k.hostname+a:k.pathname.substr(0,k.pathname.lastIndexOf("/")+1)+a,a="//"==a.substr(0,2)?k.protocol+a:k.hostname+a,z.test(a)||(a=k.protocol+"//"+a));var b=(a.split("?")[1]||"").replace(/#.*/,""),d={},c=a.substr(a.indexOf("/",8)).replace(/\?.*/,"");b&&(n(b.split("&"),function(a,b){b=a.split("=");d[b[0]]=decodeURIComponent("undefined"===typeof b[1]?"":b[1])}),b="?"+b);return{url:a,
href:a,query:d,search:b,path:c,pathname:c,hash:a.replace(/^[^#]+#/,"")}};g.setLocation=function(a){g.pushState&&x.pushState?x.pushState(null,y.title,a.url):k.hash="#!"+a.path+a.search};g.getLocation=function(){var a=k.toString();g.pushState||(a=a.split("#!").pop());return g.parseURL(a).path};var v=u.extend({data:{},boundAll:[],__lego:function(a){u.fn.__lego.call(this);h(this,a);n(this.boundAll,function(a){this[a]=this.bound(a)},this);!1!==this.inited&&this.__init()},__init:function(){this.inited=
!0;this.init();this.emit("init")},_exception:function(a,b){throw"["+this.uniqId+"."+a+"]: "+b;},isActive:function(){return!0},bound:function(a){"string"===typeof a&&(this[a]===p&&this._exception("bound",a+" -- method not found"),a=this[a]);return s(this,a)},init:t,loadData:t,destroy:t,getUrl:function(a,b,d){return this.router.getUrl(a,b,d)},setData:function(a,b){b?h(this.data,a):this.data=a;return this},getData:function(){return this.data}}),F=v.extend({el:null,$el:e(),tag:null,tagName:null,className:"",
parentNode:null,template:null,events:{},__init:function(){this.inited=!0;if(this.el)this.setElement(e(this.el,this.parentNode));else if(this.tagName||this.tag){var a=this.tagName,b=this.parentNode,d=this.className;this.tag&&(a=this.tag.match(/^(#[^\s]+)?\s*([^\.]+)\.?([^$]+)?/),a[1]&&(b=a[1]),a[3]&&(d=a[3].split(".").join(" ")),a=a[2]);this.el=y.createElement(a);this.$el=e(this.el);d&&this.$el.addClass(d);b&&(e.isReady?this.$el.appendTo(b):e(this.bound(function(){this.$el.appendTo(b)})))}else this.$el[0]=
p,this.$el.length=0;this.on("routestart.view routeend.view",this.bound(function(a){this.toggleView("routeend"!=a.type)}));v.fn.__init.call(this)},toggleView:function(a){this.$el&&this.$el.css("display",a?"":"none")},setElement:function(a){this.undelegateEvents();a?(this.$el=e(a),this.delegateEvents()):(this.$el[0]=p,this.$el.length=0);this.el=this.$el[0];return this},delegateEvents:function(a){this.undelegateEvents();n(a||this.events,function(a,d){d=d.match(/^([^\s]+)\s+(.+)/);this.$el.delegate(d[2],
d[1]+".delegateEvents"+this.cid,this.bound(a))},this);return this},undelegateEvents:function(){this.$el&&this.$el.unbind(".delegateEvents"+this.cid);return this},$:function(a){var b=this.$el;void 0!==a&&(b="string"==typeof a?b.find(a):e(a));return b},getHtml:function(a){a=a?h({},this.getData(),a):this.getData();return this.template(a)},render:function(){var a=this.getHtml();"string"===typeof a&&(this.emit("before-render"),this.$el.empty().each(function(){this.innerHTML=a}),this.emit("render"))}});
g.Route=v;g.View=F;g.version="1.0.0";l.Pilot=g})(window,jQuery);"undefined"!==typeof ajs&&ajs.loaded&&ajs.loaded("{pilot}Pilot.min");"function"===typeof define&&define.amd&&define("Pilot",[],function(){return window.Pilot||{}});